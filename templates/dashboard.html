{% extends "base.html" %}

{% block title %}Dashboard - AI Email Assistant{% endblock %}

{% block content %}
<div class="row">
    <!-- Dashboard Header -->
    <div class="dashboard-header">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="mb-2">
                    <i class="fas fa-tachometer-alt me-3"></i>
                    Email Dashboard
                </h1>
                <p class="text-muted mb-0">
                    <i class="fas fa-calendar-alt me-2"></i>
                    {{ date }} - AI-powered email insights and analysis
                </p>
            </div>
            <div class="col-md-4 text-end">
                <div class="row">
                    <div class="col-4">
                        <div class="stats-card">
                            <div class="stats-number">{{ emails|length }}</div>
                            <div class="stats-label">Emails</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stats-card">
                            <div class="stats-number" id="actionItemsCount">{{ action_items|length if action_items else 0 }}</div>
                            <div class="stats-label">Actions</div>
                        </div>
                    </div>
                    <div class="col-4">
                        <div class="stats-card">
                            <div class="stats-number" id="recommendationsCount">{{ recommendations|length if recommendations else 0 }}</div>
                            <div class="stats-label">Responses</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Summary -->
    <div class="col-lg-8 mb-4">
        <div class="card summary-card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h4 class="mb-0">
                    <i class="fas fa-chart-pie me-2"></i>
                    Daily Summary
                </h4>
                <button class="btn btn-sm btn-primary" onclick="loadAIAnalysis()" id="loadAIBtn">
                    <i class="fas fa-magic me-1"></i>
                    Load AI Analysis
                </button>
            </div>
            <div class="card-body">
                <div class="row mb-3">
                    <div class="col-md-3 text-center">
                        <div class="h4 text-primary">{{ emails|length }}</div>
                        <small class="text-muted">Recent Emails</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="h4 text-warning" id="actionItemsCount">{{ action_items|length }}</div>
                        <small class="text-muted">Action Items</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="h4 text-success" id="recommendationsCount">{{ recommendations|length }}</div>
                        <small class="text-muted">Recommendations</small>
                    </div>
                    <div class="col-md-3 text-center">
                        <div class="h4 text-info">{{ emails|selectattr('priority', 'equalto', 'high')|list|length }}</div>
                        <small class="text-muted">High Priority</small>
                    </div>
                </div>
                
                <div class="summary-content">
                    <h6 class="fw-bold mb-2">AI Analysis:</h6>
                    <div id="summaryContent">
                        {% if summary %}
                            {% if "Loading AI analysis" in summary %}
                                <div class="alert alert-info">
                                    <i class="fas fa-spinner fa-spin me-2"></i>
                                    <strong>Ready to analyze:</strong> Click "Load AI Analysis" to process your emails with AI.
                                    <br><small class="text-muted">This will analyze your emails and generate insights.</small>
                                </div>
                            {% elif "AI Analysis Unavailable" in summary %}
                                <div class="alert alert-warning">
                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                    <strong>AI Features Limited:</strong> OpenAI API quota exceeded. Using basic analysis.
                                    <br><small class="text-muted">Upgrade your OpenAI plan or check billing for full AI features.</small>
                                </div>
                            {% else %}
                                <div class="summary-text">
                                    {{ summary|safe }}
                                </div>
                            {% endif %}
                        {% else %}
                            <div class="alert alert-info">
                                <i class="fas fa-spinner fa-spin me-2"></i>
                                <strong>Ready to analyze:</strong> Click "Load AI Analysis" to process your emails with AI.
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="col-lg-4 mb-4">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">
                    <i class="fas fa-bolt me-2"></i>
                    Quick Actions
                </h5>
            </div>
            <div class="card-body">
                <div class="d-grid gap-2">
                    <button class="btn btn-outline-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-2"></i>
                        Refresh Data
                    </button>
                    <button class="btn btn-outline-success" onclick="exportSummary()">
                        <i class="fas fa-download me-2"></i>
                        Export Summary
                    </button>
                    <button class="btn btn-outline-info" onclick="showEmailThreads()">
                        <i class="fas fa-comments me-2"></i>
                        View Threads
                    </button>
                    {% if session.get('subscription_plan') == 'pro' or session.get('subscription_plan') == 'enterprise' %}
                    <button class="btn btn-outline-warning" onclick="showCustomInsights()">
                        <i class="fas fa-lightbulb me-2"></i>
                        Custom Insights
                    </button>
                    {% endif %}
                    <a href="{{ url_for('features') }}" class="btn btn-outline-secondary">
                        <i class="fas fa-star me-2"></i>
                        View All Features
                    </a>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Insights Section (Pro/Enterprise Only) -->
    {% if session.get('subscription_plan') == 'pro' or session.get('subscription_plan') == 'enterprise' %}
    <div class="col-12 mb-4" id="customInsightsSection" style="display: none;">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-lightbulb me-2"></i>
                    Custom Insights
                    <small class="text-muted ms-2">- Analyze emails based on your specific criteria</small>
                </h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="mb-3">
                            <label for="customCriteria" class="form-label">Analysis Criteria</label>
                            <textarea class="form-control" id="customCriteria" rows="3" 
                                placeholder="Enter keywords or criteria to analyze (e.g., 'urgent, deadline, project, meeting')"></textarea>
                            <div class="form-text">Separate multiple criteria with commas</div>
                        </div>
                        <div class="mb-3">
                            <label for="emailCount" class="form-label">Number of Emails to Analyze</label>
                            <select class="form-select" id="emailCount">
                                <option value="10">10 emails</option>
                                <option value="20" selected>20 emails</option>
                                <option value="50">50 emails</option>
                                <option value="100">100 emails</option>
                            </select>
                        </div>
                        <button class="btn btn-warning" onclick="generateCustomInsights()" id="generateInsightsBtn">
                            <i class="fas fa-magic me-2"></i>
                            Generate Custom Insights
                        </button>
                    </div>
                    <div class="col-md-6">
                        <div id="customInsightsResult">
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Custom Insights:</strong> Enter your analysis criteria and click "Generate Custom Insights" to get personalized AI analysis of your emails.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Action Items -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-tasks me-2"></i>
                    Action Items
                </h4>
            </div>
            <div class="card-body">
                <div id="actionItemsContent">
                    {% if action_items %}
                        {% for item in action_items %}
                            <div class="action-item">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-1">{{ item.subject }}</h6>
                                    <span class="badge priority-{{ item.priority }}">{{ item.priority|title }}</span>
                                </div>
                                <p class="text-muted small mb-2">From: {{ item.email_sender }}</p>
                                <div class="action-content">
                                    {{ item.action_items|safe }}
                                </div>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center py-3">
                            <i class="fas fa-check-circle fa-2x mb-2"></i><br>
                            No action items found for today!
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Response Recommendations -->
    <div class="col-lg-6 mb-4">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-comments me-2"></i>
                    Response Recommendations
                </h4>
            </div>
            <div class="card-body">
                <div id="recommendationsContent">
                    {% if recommendations %}
                        {% for rec in recommendations %}
                            <div class="recommendation">
                                <div class="d-flex justify-content-between align-items-start mb-2">
                                    <h6 class="mb-1">{{ rec.subject }}</h6>
                                    <span class="badge priority-{{ rec.priority }}">{{ rec.priority|title }}</span>
                                </div>
                                <p class="text-muted small mb-2">From: {{ rec.email_sender }}</p>
                                <div class="recommendation-content">
                                    {{ rec.recommendations|safe }}
                                </div>
                                <button class="btn btn-sm btn-primary mt-2" onclick="generateResponse('{{ rec.email_id }}')">
                                    <i class="fas fa-magic me-1"></i>
                                    Generate Response
                                </button>
                            </div>
                        {% endfor %}
                    {% else %}
                        <p class="text-muted text-center py-3">
                            <i class="fas fa-comments fa-2x mb-2"></i><br>
                            No response recommendations for today!
                        </p>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Email Threads -->
    <div class="col-12 mb-4">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-comments me-2"></i>
                    Email Threads
                </h4>
            </div>
            <div class="card-body">
                {% if email_threads %}
                    <div class="row">
                        {% for thread_key, thread in email_threads.items() %}
                            <div class="col-md-6 mb-3">
                                <div class="card thread-card">
                                    <div class="card-body">
                                        <div class="d-flex justify-content-between align-items-start mb-2">
                                            <h6 class="mb-1">{{ thread.subject }}</h6>
                                            <span class="badge priority-{{ thread.priority }}">{{ thread.priority|title }}</span>
                                        </div>
                                        <p class="text-muted small mb-2">
                                            <i class="fas fa-user me-1"></i>
                                            {{ thread.sender }}
                                        </p>
                                        <p class="text-muted small mb-2">
                                            <i class="fas fa-comments me-1"></i>
                                            {{ thread.thread_count }} message{{ 's' if thread.thread_count != 1 else '' }}
                                        </p>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-outline-primary" onclick="viewThread('{{ thread_key }}')">
                                                <i class="fas fa-eye me-1"></i>
                                                View Thread
                                            </button>
                                            <button class="btn btn-outline-success" onclick="analyzeThread('{{ thread_key }}')">
                                                <i class="fas fa-magic me-1"></i>
                                                Analyze
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted text-center py-3">
                        <i class="fas fa-comments fa-2x mb-2"></i><br>
                        No email threads found for today!
                    </p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Recent Emails -->
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="mb-0">
                    <i class="fas fa-envelope me-2"></i>
                    Recent Emails
                </h4>
            </div>
            <div class="card-body">
                {% if emails %}
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead>
                                <tr>
                                    <th>Sender</th>
                                    <th>Subject</th>
                                    <th>Priority</th>
                                    <th>Type</th>
                                    <th>Time</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for email in emails %}
                                    <tr class="email-card">
                                        <td>
                                            <strong>{{ email.sender_clean or email.sender }}</strong>
                                            <br>
                                            <small class="text-muted">{{ email.sender_domain }}</small>
                                        </td>
                                        <td>
                                            <div class="fw-medium">{{ email.subject }}</div>
                                            <small class="text-muted">{{ email.body_preview }}</small>
                                        </td>
                                        <td>
                                            <span class="badge priority-{{ email.priority }}">
                                                {{ email.priority|title }}
                                            </span>
                                        </td>
                                        <td>
                                            <span class="badge bg-secondary">{{ email.category|title }}</span>
                                        </td>
                                        <td>
                                            <small>{{ email.date.split('T')[1][:5] if 'T' in email.date else email.date }}</small>
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button class="btn btn-outline-primary" onclick="viewEmail('{{ email.id }}')">
                                                    <i class="fas fa-eye"></i>
                                                </button>
                                                <button class="btn btn-outline-success" onclick="generateResponse('{{ email.id }}')">
                                                    <i class="fas fa-reply"></i>
                                                </button>
                                            </div>
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted text-center py-4">
                        <i class="fas fa-inbox fa-3x mb-3"></i><br>
                        No emails found for today!
                    </p>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- Email Modal -->
<div class="modal fade" id="emailModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Email Details</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="emailModalBody">
                <!-- Email content will be loaded here -->
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="generateResponseFromModal()">
                    <i class="fas fa-magic me-1"></i>
                    Generate Response
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Response Modal -->
<div class="modal fade" id="responseModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">AI Generated Response</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="responseContent">
                    <div class="loading">
                        <div class="spinner"></div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-success" onclick="copyResponse()">
                    <i class="fas fa-copy me-1"></i>
                    Copy Response
                </button>
            </div>
        </div>
    </div>
</div>

<style>
    /* Dashboard-specific modern styling */
    .dashboard-header {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.95));
        backdrop-filter: blur(20px);
        border-radius: 24px;
        padding: 32px;
        margin-bottom: 32px;
        border: 1px solid var(--glass-border);
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }
    
    .stats-card {
        background: linear-gradient(135deg, rgba(255, 255, 255, 0.9), rgba(248, 250, 252, 0.9));
        backdrop-filter: blur(15px);
        border-radius: 20px;
        padding: 24px;
        text-align: center;
        border: 1px solid var(--glass-border);
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }
    
    .stats-card:hover {
        transform: translateY(-4px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.1);
    }
    
    .stats-number {
        font-size: 2.5rem;
        font-weight: 800;
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 8px;
    }
    
    .stats-label {
        color: #6b7280;
        font-weight: 600;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }
    
    .table {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(15px);
        border-radius: 16px;
        overflow: hidden;
        border: 1px solid var(--glass-border);
    }
    
    .table thead th {
        background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        color: white;
        border: none;
        font-weight: 600;
        padding: 16px 20px;
    }
    
    .table tbody tr {
        transition: all 0.3s ease;
    }
    
    .table tbody tr:hover {
        background: rgba(99, 102, 241, 0.05);
        transform: scale(1.01);
    }
    
    .table tbody td {
        padding: 16px 20px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.05);
    }
    
    /* Modern form elements */
    .form-control {
        background: rgba(255, 255, 255, 0.9);
        backdrop-filter: blur(10px);
        border: 1px solid var(--glass-border);
        border-radius: 12px;
        padding: 12px 16px;
        transition: all 0.3s ease;
    }
    
    .form-control:focus {
        background: rgba(255, 255, 255, 0.95);
        border-color: var(--primary-color);
        box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
    }
    
    /* Enhanced modal styling */
    .modal-dialog {
        max-width: 800px;
    }
    
    .modal-content {
        border-radius: 24px;
        overflow: hidden;
    }
    
    .modal-header {
        padding: 24px 28px;
    }
    
    .modal-body {
        padding: 28px;
    }
    
    .modal-footer {
        padding: 20px 28px;
        border-top: 1px solid var(--glass-border);
    }
    
    /* Thread messages styling */
    .thread-message {
        background: rgba(255, 255, 255, 0.95);
        border: 1px solid rgba(0, 0, 0, 0.08);
        border-radius: 12px;
        margin-bottom: 16px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
        transition: all 0.2s ease;
    }
    
    .thread-message:hover {
        box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
        transform: translateY(-1px);
    }
    
    .thread-message-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 16px 20px 0;
        border-bottom: 1px solid rgba(0, 0, 0, 0.06);
        margin-bottom: 0;
    }
    
    .thread-message-header span:first-child {
        font-weight: 600;
        color: #1f2937;
        font-size: 0.95rem;
    }
    
    .thread-message-time {
        color: #6b7280;
        font-size: 0.85rem;
        font-weight: 500;
    }
    
    .thread-message-body {
        background: rgba(248, 250, 252, 0.6);
        border-radius: 8px;
        padding: 16px 20px;
        margin: 16px 20px 20px;
        border-left: 3px solid #e5e7eb;
        border: none;
    }
    
    .thread-modal-content h5 {
        color: #1f2937;
        font-weight: 700;
        margin-bottom: 8px;
    }
    
    .thread-messages-list {
        max-height: 60vh;
        overflow-y: auto;
        padding-right: 8px;
    }
    
    /* Enhanced scrollbar for thread messages */
    .thread-messages-list::-webkit-scrollbar {
        width: 6px;
    }
    
    .thread-messages-list::-webkit-scrollbar-track {
        background: #f1f5f9;
        border-radius: 3px;
    }
    
    .thread-messages-list::-webkit-scrollbar-thumb {
        background: #cbd5e1;
        border-radius: 3px;
    }
    
    .thread-messages-list::-webkit-scrollbar-thumb:hover {
        background: #94a3b8;
    }
    
    /* Enhanced button groups */
    .btn-group .btn {
        border-radius: 12px;
        margin: 0 2px;
    }
    
    .btn-group .btn:first-child {
        border-radius: 12px 0 0 12px;
    }
    
    .btn-group .btn:last-child {
        border-radius: 0 12px 12px 0;
    }
    
    /* Loading overlay */
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(5px);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }
    
    .loading-content {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(20px);
        border-radius: 20px;
        padding: 32px;
        text-align: center;
        border: 1px solid var(--glass-border);
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.2);
    }
    
    /* Enhanced alerts */
    .alert {
        border-radius: 16px;
        border: none;
        backdrop-filter: blur(15px);
        font-weight: 500;
    }
    
    .alert-info {
        background: linear-gradient(135deg, rgba(219, 234, 254, 0.9), rgba(191, 219, 254, 0.9));
        color: #1e40af;
    }
    
    .alert-success {
        background: linear-gradient(135deg, rgba(209, 250, 229, 0.9), rgba(167, 243, 208, 0.9));
        color: #065f46;
    }
    
    .alert-danger {
        background: linear-gradient(135deg, rgba(254, 226, 226, 0.9), rgba(252, 165, 165, 0.9));
        color: #991b1b;
    }
    
    /* Responsive improvements */
    @media (max-width: 768px) {
        .dashboard-header {
            padding: 16px 8px;
            margin-bottom: 16px;
        }
        .stats-card {
            padding: 12px;
            margin-bottom: 12px;
        }
        .stats-number {
            font-size: 1.5rem;
        }
        .modal-body {
            padding: 10px;
        }
        .table-responsive {
            border-radius: 10px;
            overflow-x: auto;
        }
        .card-header, .card-body {
            padding: 12px 8px;
        }
        .summary-card h4, .card h4, .card h5 {
            font-size: 1.1rem;
        }
        .btn, .btn-group-sm > .btn {
            font-size: 0.95rem;
            padding: 8px 12px;
        }
        .email-card td, .email-card th {
            padding: 6px 4px;
            font-size: 0.95rem;
        }
        .action-item, .recommendation {
            font-size: 0.95rem;
        }
    }
    /* Extra small devices (phones, <576px) */
    @media (max-width: 576px) {
        .dashboard-header {
            flex-direction: column;
            text-align: center;
        }
        .stats-card {
            margin-bottom: 8px;
            padding: 8px;
        }
        .row, .col-lg-8, .col-lg-4, .col-lg-6, .col-12, .col-md-6, .col-md-4, .col-md-3, .col-4 {
            flex-direction: column !important;
            width: 100% !important;
            max-width: 100% !important;
        }
        .card {
            margin-bottom: 10px;
        }
        .table-responsive {
            border-radius: 6px;
            overflow-x: auto;
        }
        .table {
            font-size: 0.92rem;
        }
        .btn, .btn-group-sm > .btn {
            font-size: 1rem;
            padding: 10px 16px;
        }
        .modal-dialog {
            max-width: 98vw;
            margin: 0 auto;
        }
        .modal-content {
            border-radius: 10px;
        }
        .summary-card h4, .card h4, .card h5 {
            font-size: 1rem;
        }
        .email-content {
            font-size: 0.92rem;
        }
    }

    /* Enhanced email content styling */
    .email-content {
        font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        line-height: 1.6;
        color: #374151;
        font-size: 0.95rem;
    }
    
    .email-content strong {
        color: #1f2937;
        font-weight: 600;
    }
    
    .email-content code {
        background-color: #f3f4f6;
        color: #374151;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: 'SF Mono', Monaco, 'Cascadia Code', monospace;
        font-size: 0.85rem;
    }
</style>
{% endblock %}

{% block extra_js %}
<script>
let currentEmailId = null;
let emailThreads = {{ email_threads|tojson }};
let emails = {{ emails|tojson }};

// Debug: Log the emailThreads structure
console.log("üîç Email Threads Debug:");
console.log("emailThreads type:", typeof emailThreads);
console.log("emailThreads keys:", Object.keys(emailThreads));
console.log("emailThreads full data:", emailThreads);

// Check each thread structure
Object.entries(emailThreads).forEach(([key, thread]) => {
    console.log(`Thread ${key}:`, {
        subject: thread.subject,
        sender: thread.sender,
        thread_count: thread.thread_count,
        emails_type: typeof thread.emails,
        emails_is_array: Array.isArray(thread.emails),
        emails_length: thread.emails ? thread.emails.length : 'undefined',
        emails_content: thread.emails
    });
});

// Check subscription level for feature access
function checkSubscriptionLevel(requiredLevel) {
    const userPlan = '{{ session.get("subscription_plan", "free") }}';
    const planHierarchy = ['free', 'pro', 'enterprise'];
    
    const userIndex = planHierarchy.indexOf(userPlan);
    const requiredIndex = planHierarchy.indexOf(requiredLevel);
    
    return userIndex >= requiredIndex;
}

// Handle subscription-gated features
function handleSubscriptionGatedFeature(featureName, requiredLevel, callback) {
    if (checkSubscriptionLevel(requiredLevel)) {
        callback();
    } else {
        const planNames = {
            'pro': 'Pro',
            'enterprise': 'Enterprise'
        };
        const requiredPlan = planNames[requiredLevel] || requiredLevel;
        
        Swal.fire({
            title: 'Feature Requires Upgrade',
            html: `
                <div class="text-center">
                    <i class="fas fa-lock fa-3x text-warning mb-3"></i>
                    <h5>${featureName} requires a ${requiredPlan} subscription</h5>
                    <p class="text-muted">Upgrade your plan to access this advanced feature.</p>
                </div>
            `,
            icon: 'info',
            showCancelButton: true,
            confirmButtonText: 'Upgrade Now',
            cancelButtonText: 'Maybe Later',
            confirmButtonColor: '#007bff'
        }).then((result) => {
            if (result.isConfirmed) {
                window.location.href = '/pricing';
            }
        });
    }
}

// Enhanced AI analysis with subscription check
function loadAIAnalysis() {
    handleSubscriptionGatedFeature('Advanced AI Analysis', 'pro', () => {
        var btn = document.getElementById('loadAIBtn');
        btn.disabled = true;
        btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Loading...';
        
        var emailId = (emails && emails.length > 0) ? emails[0].id : null;
        if (!emailId) {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-magic me-1"></i> Load AI Analysis';
            document.getElementById('summaryContent').innerHTML = '<div class="alert alert-danger">No emails available to analyze.</div>';
            return;
        }
        
        fetch('/api/analyze-email', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ email_id: emailId }),
            credentials: 'include'
        })
        .then(response => {
            if (response.status === 403) {
                throw new Error('Subscription required');
            }
            return response.json();
        })
        .then(data => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-magic me-1"></i> Load AI Analysis';
            if (data.success && data.content) {
                document.getElementById('summaryContent').innerHTML = '<div class="summary-text">' + data.content + '</div>';
            } else {
                document.getElementById('summaryContent').innerHTML = '<div class="alert alert-danger">' + (data.error || 'Failed to process emails. Please try again later.') + '</div>';
            }
        })
        .catch(err => {
            btn.disabled = false;
            btn.innerHTML = '<i class="fas fa-magic me-1"></i> Load AI Analysis';
            if (err.message === 'Subscription required') {
                handleSubscriptionGatedFeature('Advanced AI Analysis', 'pro', () => {});
            } else {
                document.getElementById('summaryContent').innerHTML = '<div class="alert alert-danger">Error: Failed to process emails. Please try again later.</div>';
            }
        });
    });
}

function updateActionItems(actionItems) {
    const container = document.getElementById('actionItemsContent');
    
    if (actionItems.length === 0) {
        container.innerHTML = `
            <p class="text-muted text-center py-3">
                <i class="fas fa-check-circle fa-2x mb-2"></i><br>
                No action items found for today!
            </p>
        `;
        return;
    }
    
    let html = '';
    actionItems.forEach(item => {
        html += `
            <div class="action-item">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="mb-1">${item.subject || 'No Subject'}</h6>
                    <span class="badge priority-${item.priority || 'medium'}">${item.priority || 'medium'}</span>
                </div>
                <p class="text-muted small mb-2">From: ${item.email_sender || 'Unknown'}</p>
                <div class="action-content">
                    ${item.action_items}
                </div>
                <small class="text-muted">
                    <i class="fas fa-robot me-1"></i>
                    Analyzed with ${item.model_used || 'AI'}
                </small>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function updateRecommendations(recommendations) {
    const container = document.getElementById('recommendationsContent');
    
    if (recommendations.length === 0) {
        container.innerHTML = `
            <p class="text-muted text-center py-3">
                <i class="fas fa-comments fa-2x mb-2"></i><br>
                No response recommendations for today!
            </p>
        `;
        return;
    }
    
    let html = '';
    recommendations.forEach(rec => {
        html += `
            <div class="recommendation">
                <div class="d-flex justify-content-between align-items-start mb-2">
                    <h6 class="mb-1">${rec.subject || 'No Subject'}</h6>
                    <span class="badge priority-${rec.priority || 'medium'}">${rec.priority || 'medium'}</span>
                </div>
                <p class="text-muted small mb-2">From: ${rec.email_sender || 'Unknown'}</p>
                <div class="recommendation-content">
                    ${rec.recommendations}
                </div>
                <div class="d-flex justify-content-between align-items-center mt-2">
                    <small class="text-muted">
                        <i class="fas fa-robot me-1"></i>
                        Analyzed with ${rec.model_used || 'AI'}
                    </small>
                    <button class="btn btn-sm btn-primary" onclick="generateResponse('${rec.email_id}')">
                        <i class="fas fa-magic me-1"></i>
                        Generate Response
                    </button>
                </div>
            </div>
        `;
    });
    
    container.innerHTML = html;
}

function showAlert(type, message) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    alertDiv.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    alertDiv.innerHTML = `
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    document.body.appendChild(alertDiv);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

function refreshData() {
    location.reload();
}

function exportSummary() {
    const data = {
        date: '{{ date }}',
        summary: document.getElementById('summaryContent').innerText,
        actionItems: {{ action_items|tojson }},
        recommendations: {{ recommendations|tojson }},
        emails: emails
    };
    
    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `email-summary-${new Date().toISOString().split('T')[0]}.json`;
    a.click();
    URL.revokeObjectURL(url);
}

function showEmailThreads() {
    // Show email threads in a modal
    const modalBody = document.getElementById('emailModalBody');
    
    // Check if emailThreads is defined and has data
    if (!emailThreads || Object.keys(emailThreads).length === 0) {
        modalBody.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                <h5>No Email Threads</h5>
                <p class="text-muted">No email threads found for today.</p>
                <button class="btn btn-primary" onclick="refreshData()">
                    <i class="fas fa-refresh me-1"></i>
                    Refresh Data
                </button>
            </div>
        `;
    } else {
        let threadsHtml = '';
        Object.entries(emailThreads).forEach(([threadKey, thread]) => {
            threadsHtml += `
                <div class="card mb-3 thread-overview-card">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="mb-1 text-truncate">${thread.subject || 'No Subject'}</h6>
                            <span class="badge priority-${thread.priority || 'medium'}">${(thread.priority || 'medium').toUpperCase()}</span>
                        </div>
                        <p class="text-muted small mb-2">
                            <i class="fas fa-user me-1"></i>
                            ${thread.sender || 'Unknown Sender'}
                        </p>
                        <p class="text-muted small mb-2">
                            <i class="fas fa-comments me-1"></i>
                            ${thread.thread_count || 1} message${(thread.thread_count || 1) !== 1 ? 's' : ''}
                        </p>
                        <div class="btn-group btn-group-sm w-100">
                            <button class="btn btn-outline-primary" onclick="viewThread('${threadKey}')">
                                <i class="fas fa-eye me-1"></i>
                                View Thread
                            </button>
                            <button class="btn btn-outline-success" onclick="analyzeThread('${threadKey}')">
                                <i class="fas fa-magic me-1"></i>
                                Analyze
                            </button>
                        </div>
                    </div>
                </div>
            `;
        });
        
        modalBody.innerHTML = `
            <div class="mb-3">
                <h5><i class="fas fa-comments me-2"></i>Email Threads Overview</h5>
                <p class="text-muted">Found ${Object.keys(emailThreads).length} email thread${Object.keys(emailThreads).length !== 1 ? 's' : ''} for today.</p>
            </div>
            <div class="threads-list">
                ${threadsHtml}
            </div>
        `;
    }
    
    new bootstrap.Modal(document.getElementById('emailModal')).show();
}

function viewThread(threadKey) {
    console.log("üîç viewThread called with key:", threadKey);
    console.log("üîç emailThreads available:", typeof emailThreads);
    console.log("üîç emailThreads keys:", Object.keys(emailThreads));
    
    // Check if emailThreads is defined
    if (!emailThreads) {
        console.error("‚ùå emailThreads is not defined");
        alert("Error: emailThreads data not available");
        return;
    }
    
    // Check if the modal element exists
    const modalElement = document.getElementById('emailModal');
    if (!modalElement) {
        console.error("‚ùå emailModal element not found");
        alert("Error: Modal element not found");
        return;
    }
    
    // Check if Bootstrap is available
    if (typeof bootstrap === 'undefined') {
        console.error("‚ùå Bootstrap is not loaded");
        alert("Error: Bootstrap not loaded");
        return;
    }
    
    const thread = emailThreads[threadKey];
    console.log("üîç Thread data for key:", threadKey, thread);
    console.log("üîç Thread emails type:", typeof thread?.emails);
    console.log("üîç Thread emails is array:", Array.isArray(thread?.emails));
    console.log("üîç Thread emails length:", thread?.emails?.length);

    const modalBody = document.getElementById('emailModalBody');
    if (!thread || !Array.isArray(thread.emails) || thread.emails.length === 0) {
        console.log("‚ùå Thread data is invalid:", thread);
        modalBody.innerHTML = `
            <div class="text-center py-4">
                <i class="fas fa-exclamation-triangle fa-3x text-danger mb-3"></i>
                <h5>Unable to load thread</h5>
                <p class="text-muted">No messages found in this thread.<br>
                <code>${JSON.stringify(thread)}</code></p>
            </div>
        `;
        new bootstrap.Modal(modalElement).show();
        return;
    }

    // Create thread messages HTML with modern styling
    let threadMessagesHtml = '';
    thread.emails.forEach((email, index) => {
        console.log(`üîç Processing email ${index}:`, email);
        const time = email.date && email.date.includes('T') ? email.date.split('T')[1].substring(0, 5) : (email.date || '');
        const formattedContent = formatEmailContent(email.body_clean || email.body || '');
        
        threadMessagesHtml += `
            <div class="thread-message">
                <div class="thread-message-header">
                    <span><i class="fas fa-user me-2"></i>${email.sender_clean || email.sender}</span>
                    <span class="thread-message-time"><i class="fas fa-clock me-1"></i>${time}</span>
                </div>
                <div class="thread-message-body mt-3">
                    <div class="email-content">
                        ${formattedContent}
                    </div>
                </div>
            </div>
        `;
    });
    modalBody.innerHTML = `
        <div class="thread-modal-content">
            <h5><i class="fas fa-comments me-2"></i>Thread: ${thread.subject || 'No Subject'}</h5>
            <div class="thread-messages-list mt-3">
                ${threadMessagesHtml}
            </div>
        </div>
    `;
    
    console.log("‚úÖ About to show modal");
    // Show the modal
    new bootstrap.Modal(modalElement).show();
    console.log("‚úÖ Modal show called");
}

function formatEmailContent(content) {
    if (!content) return '';
    
    console.log("üîç Original content:", content.substring(0, 200) + "...");
    
    // Step 1: Preserve important structural elements before cleaning
    let cleaned = content
        // Preserve paragraph breaks and headers
        .replace(/<\/?(h[1-6])[^>]*>/gi, '\n\n**$1**\n')
        .replace(/<\/p>/gi, '\n\n')
        .replace(/<p[^>]*>/gi, '\n')
        .replace(/<\/div>/gi, '\n')
        .replace(/<div[^>]*>/gi, '\n')
        .replace(/<br\s*\/?>/gi, '\n')
        
        // Preserve links but clean them up
        .replace(/<a[^>]*href\s*=\s*["']([^"']*)["'][^>]*>([^<]*)<\/a>/gi, '$2 [$1]')
        
        // Remove style blocks and scripts completely
        .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')
        .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
        
        // Remove inline CSS and attributes
        .replace(/style\s*=\s*["'][^"']*["']/gi, '')
        .replace(/class\s*=\s*["'][^"']*["']/gi, '')
        .replace(/id\s*=\s*["'][^"']*["']/gi, '')
        .replace(/width\s*=\s*["'][^"']*["']/gi, '')
        .replace(/height\s*=\s*["'][^"']*["']/gi, '')
        
        // Remove all remaining HTML tags
        .replace(/<[^>]+>/g, '')
        
        // Decode HTML entities
        .replace(/&nbsp;/g, ' ')
        .replace(/&amp;/g, '&')
        .replace(/&lt;/g, '<')
        .replace(/&gt;/g, '>')
        .replace(/&quot;/g, '"')
        .replace(/&#39;/g, "'")
        .replace(/&hellip;/g, '...')
        .replace(/&mdash;/g, '‚Äî')
        .replace(/&ndash;/g, '‚Äì')
        .replace(/&rsquo;/g, "'")
        .replace(/&lsquo;/g, "'")
        .replace(/&rdquo;/g, '"')
        .replace(/&ldquo;/g, '"')
        
        // Clean up CSS remnants
        .replace(/\b\w+\s*:\s*[^;]+;/g, '')
        .replace(/\{[^}]*\}/g, '')
        
        // Clean up whitespace but preserve paragraph structure
        .replace(/[ \t]+/g, ' ')  // Multiple spaces/tabs to single space
        .replace(/\n[ \t]+/g, '\n')  // Remove spaces/tabs at start of lines
        .replace(/[ \t]+\n/g, '\n')  // Remove spaces/tabs at end of lines
        .replace(/\n{4,}/g, '\n\n\n')  // Max triple line breaks
        .trim();

    console.log("üîç After initial cleaning:", cleaned.substring(0, 200) + "...");
    
    // Step 2: Parse and intelligently format the content
    const paragraphs = cleaned.split(/\n{2,}/).filter(p => p.trim().length > 0);
    const formattedParagraphs = [];
    
    for (let i = 0; i < paragraphs.length; i++) {
        let paragraph = paragraphs[i].trim();
        if (!paragraph) continue;
        
        // Skip CSS remnants
        if (paragraph.match(/^(font-family|color|text-align|height|width|margin|padding|display)/i)) {
            continue;
        }
        
        // Format headers (lines that look like titles)
        if (paragraph.length < 100 && 
            (paragraph.match(/^[A-Z][^.!?]*$/) || 
             paragraph.includes('**h') ||
             (i === 0 && paragraph.length < 80))) {
            formattedParagraphs.push(`<h6 class="text-primary fw-bold mb-2">${paragraph.replace(/\*\*h\d+\*\*/g, '')}</h6>`);
            continue;
        }
        
        // Format paragraphs with proper line breaks
        const lines = paragraph.split('\n').filter(line => line.trim().length > 0);
        const formattedLines = [];
        
        for (const line of lines) {
            let formattedLine = line.trim();
            
            // Format key-value pairs (like in bank notifications)
            if (formattedLine.includes(':') && formattedLine.split(':').length === 2) {
                const [key, value] = formattedLine.split(':').map(part => part.trim());
                if (key.length < 50 && value.length > 0 && 
                    !key.match(/^(font-family|color|text-align|https?)/i)) {
                    formattedLines.push(`<strong>${key}:</strong> ${value}`);
                    continue;
                }
            }
            
            // Format currency amounts
            formattedLine = formattedLine.replace(/\b(NGN|USD|EUR|GBP)\s*(\d+(?:,\d{3})*(?:\.\d{2})?)/g, 
                                               '<strong class="text-success">$1 $2</strong>');
            
            // Format account numbers (partially masked)
            formattedLine = formattedLine.replace(/\*{4,}\d{4}/g, '<code class="bg-light px-1">$&</code>');
            
            // Format transaction references
            formattedLine = formattedLine.replace(/\b\d{12,}\b/g, '<code class="bg-light px-1">$&</code>');
            
            // Bold important terms
            formattedLine = formattedLine.replace(/\b(DEBIT|CREDIT|Account Number|Transaction|Amount|Balance|Reference|View this post|By |Author:)\b/gi, 
                                               '<strong>$1</strong>');
            
            // Format URLs nicely
            formattedLine = formattedLine.replace(/\[(https?:\/\/[^\]]+)\]/g, 
                                               '<a href="$1" target="_blank" class="text-decoration-none"><i class="fas fa-external-link-alt me-1"></i>Link</a>');
            
            formattedLines.push(formattedLine);
        }
        
        // Join lines within paragraph with proper spacing
        const paragraphContent = formattedLines.join('<br>');
        
        if (paragraphContent.trim()) {
            formattedParagraphs.push(`<p class="mb-3">${paragraphContent}</p>`);
        }
    }
    
    // Step 3: Join paragraphs
    let result = formattedParagraphs.join('\n');
    
    // Step 4: Final cleanup
    result = result.replace(/(<br>\s*){3,}/g, '<br><br>');  // Max double line breaks
    result = result.replace(/<p class="mb-3">\s*<\/p>/g, '');  // Remove empty paragraphs
    
    console.log("üîç Final formatted content:", result.substring(0, 200) + "...");
    
    return result;
}

function analyzeThread(threadKey) {
    const thread = emailThreads[threadKey];
    if (!thread) {
        showAlert('error', 'Thread not found');
        return;
    }
    
    // Show loading state
    const modalBody = document.getElementById('emailModalBody');
    modalBody.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-primary mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h5>Analyzing Thread</h5>
            <p class="text-muted">Analyzing "${thread.subject}" with AI...</p>
        </div>
    `;
    
    new bootstrap.Modal(document.getElementById('emailModal')).show();
    
    // Use the first email in the thread for analysis (which will include attachments)
    const firstEmail = thread.emails[0];
    if (!firstEmail) {
        modalBody.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Error:</strong> No emails found in thread
            </div>
        `;
        return;
    }
    
    // Call the API endpoint with thread analysis type
    fetch('/api/analyze-email', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            email_id: firstEmail.id,
            type: 'thread_analysis'
        }),
        credentials: 'include'
    })
    .then(response => {
        if (response.status === 403) {
            return response.json().then(data => {
                throw new Error(JSON.stringify({
                    type: 'subscription',
                    message: data.error,
                    feature: data.feature
                }));
            });
        }
        if (response.status === 429) {
            return response.json().then(data => {
                throw new Error(JSON.stringify({
                    type: 'limit',
                    message: data.error,
                    feature: data.feature
                }));
            });
        }
        if (!response.ok) {
            return response.json().then(data => {
                throw new Error(data.error || 'Analysis failed');
            });
        }
        return response.json();
    })
    .then(data => {
        if (data.success) {
            let attachmentInfo = '';
            if (data.has_attachments && data.attachment_summary) {
                attachmentInfo = `
                    <div class="alert alert-info">
                        <i class="fas fa-paperclip me-2"></i>
                        <strong>Attachments Processed:</strong> ${data.attachment_summary.processed}/${data.attachment_summary.total}
                        ${data.attachment_summary.document_types.length > 0 ? 
                            `<br><strong>Document Types:</strong> ${data.attachment_summary.document_types.join(', ')}` : ''}
                    </div>
                `;
            }
            
            // Show upgrade banner for basic analysis
            let upgradeBanner = '';
            if (data.is_basic && data.user_plan === 'free') {
                upgradeBanner = `
                    <div class="alert alert-info border-0 bg-gradient-primary text-white mb-3">
                        <div class="d-flex align-items-center">
                            <i class="fas fa-star me-2"></i>
                            <div class="flex-grow-1">
                                <strong>Basic Analysis Provided</strong><br>
                                <small>Upgrade to Pro for comprehensive AI insights, action items, and recommendations</small>
                            </div>
                            <a href="/pricing" class="btn btn-light btn-sm">
                                <i class="fas fa-crown me-1"></i>Upgrade
                            </a>
                        </div>
                    </div>
                `;
            }
            
            modalBody.innerHTML = `
                <div class="mb-3">
                    <h5><i class="fas fa-magic me-2"></i>Thread Analysis</h5>
                    <p class="text-muted">Analysis of "${thread.subject}"</p>
                    <small class="text-muted">
                        <i class="fas fa-robot me-1"></i>
                        Analyzed with ${data.model_used || 'AI'}
                    </small>
                </div>
                ${upgradeBanner}
                ${attachmentInfo}
                <div class="border-top pt-3">
                    <h6>Thread Analysis:</h6>
                    <div class="analysis-content bg-light p-3 rounded">
                        ${formatEmailContent(data.content)}
                    </div>
                </div>
                <div class="mt-3">
                    <h6>Thread Details:</h6>
                    <ul class="list-unstyled">
                        <li><strong>Subject:</strong> ${thread.subject}</li>
                        <li><strong>Sender:</strong> ${thread.sender}</li>
                        <li><strong>Messages:</strong> ${thread.thread_count}</li>
                        <li><strong>Priority:</strong> <span class="badge priority-${thread.priority}">${thread.priority}</span></li>
                        ${data.has_attachments ? `<li><strong>Attachments:</strong> <span class="badge bg-info">${data.attachments_processed} processed</span></li>` : ''}
                    </ul>
                </div>
            `;
        } else {
            modalBody.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Analysis Failed:</strong> ${data.error || 'Unknown error'}
                    ${data.technical_error ? `<br><small class="text-muted">Technical details: ${data.technical_error}</small>` : ''}
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error analyzing thread:', error);
        
        try {
            const errorData = JSON.parse(error.message);
            
            if (errorData.type === 'subscription') {
                modalBody.innerHTML = `
                    <div class="text-center py-4">
                        <div class="mb-3">
                            <i class="fas fa-crown fa-3x text-warning"></i>
                        </div>
                        <h5>Upgrade Required</h5>
                        <p class="text-muted mb-3">${errorData.message}</p>
                        <div class="d-grid gap-2">
                            <a href="/pricing" class="btn btn-primary">
                                <i class="fas fa-star me-2"></i>Upgrade to Pro
                            </a>
                            <button class="btn btn-outline-secondary" onclick="viewThread(\'' + threadKey + '\')">
                                <i class="fas fa-eye me-2"></i>View Thread Instead
                            </button>
                        </div>
                    </div>
                `;
            } else if (errorData.type === 'limit') {
                modalBody.innerHTML = `
                    <div class="text-center py-4">
                        <div class="mb-3">
                            <i class="fas fa-exclamation-triangle fa-3x text-warning"></i>
                        </div>
                        <h5>Usage Limit Reached</h5>
                        <p class="text-muted mb-3">${errorData.message}</p>
                        <div class="d-grid gap-2">
                            <a href="/pricing" class="btn btn-primary">
                                <i class="fas fa-infinity me-2"></i>Get Unlimited Access
                            </a>
                            <a href="/account" class="btn btn-outline-secondary">
                                <i class="fas fa-chart-bar me-2"></i>View Usage
                            </a>
                        </div>
                    </div>
                `;
            } else {
                throw error; // Re-throw if not a parsed error
            }
        } catch (parseError) {
            // Handle general errors
            modalBody.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Error:</strong> ${error.message || 'Failed to analyze thread. Please try again.'}
                    <div class="mt-2">
                        <button class="btn btn-sm btn-outline-primary" onclick="analyzeThread(\'' + threadKey + '\')">
                            <i class="fas fa-redo me-1"></i>Try Again
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" onclick="viewThread(\'' + threadKey + '\')">
                            <i class="fas fa-eye me-1"></i>View Thread
                        </button>
                    </div>
                </div>
            `;
        }
    });
}

function viewEmail(emailId) {
    // Find email data
    const email = emails.find(e => e.id === emailId);
    
    if (email) {
        const modalBody = document.getElementById('emailModalBody');
        const formattedContent = formatEmailContent(email.body_clean || email.body);
        
        modalBody.innerHTML = `
            <div class="mb-3">
                <strong>From:</strong> ${email.sender}<br>
                <strong>Subject:</strong> ${email.subject}<br>
                <strong>Date:</strong> ${email.date}<br>
                <strong>Priority:</strong> <span class="badge priority-${email.priority}">${email.priority}</span><br>
                <strong>Category:</strong> <span class="badge bg-secondary">${email.category}</span>
            </div>
            <div class="border-top pt-3">
                <h6>Email Content:</h6>
                <div class="bg-light p-3 rounded">
                    <div class="email-content">
                        ${formattedContent}
                    </div>
                </div>
            </div>
        `;
        
        currentEmailId = emailId;
        new bootstrap.Modal(document.getElementById('emailModal')).show();
    }
}

function generateResponse(emailId) {
    console.log('üîç [DEBUG] generateResponse called with emailId:', emailId);
    console.log('üîç [DEBUG] Current email data:', emails.find(e => e.id === emailId));
    
    currentEmailId = emailId;
    new bootstrap.Modal(document.getElementById('responseModal')).show();
    
    // Show loading
    document.getElementById('responseContent').innerHTML = `
        <div class="loading">
            <div class="spinner"></div>
            <p class="mt-2">Generating response...</p>
        </div>
    `;
    
    const requestBody = { email_id: emailId };
    console.log('üîç [DEBUG] Request body:', requestBody);
    console.log('üîç [DEBUG] Making API call to /api/generate-response...');
    
    // Call backend API to generate response
    fetch('/api/generate-response', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(requestBody),
        credentials: 'include'
    })
    .then(response => {
        console.log('üîç [DEBUG] Response status:', response.status);
        console.log('üîç [DEBUG] Response headers:', Object.fromEntries(response.headers.entries()));
        
        if (!response.ok) {
            console.error('‚ùå [DEBUG] Response not OK:', response.status, response.statusText);
            throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }
        
        return response.json();
    })
    .then(data => {
        console.log('üîç [DEBUG] Response data:', data);
        
        if (data.success) {
            console.log('‚úÖ [DEBUG] Success - generating response display');
            document.getElementById('responseContent').innerHTML = `
                <div class="alert alert-success">
                    <i class="fas fa-magic me-2"></i>
                    AI-generated response ready!
                </div>
                <div class="bg-light p-3 rounded">
                    ${formatEmailContent(data.response)}
                </div>
            `;
        } else {
            console.error('‚ùå [DEBUG] API returned success=false:', data.error);
            document.getElementById('responseContent').innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Error:</strong> ${data.error || 'Failed to generate response.'}
                    ${data.debug ? `<br><small class="text-muted">Debug: ${JSON.stringify(data.debug)}</small>` : ''}
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('‚ùå [DEBUG] Fetch error:', error);
        console.error('‚ùå [DEBUG] Error details:', {
            name: error.name,
            message: error.message,
            stack: error.stack
        });
        
        document.getElementById('responseContent').innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Error:</strong> Failed to generate response. Please try again.
                <br><small class="text-muted">Debug: ${error.message}</small>
            </div>
        `;
    });
}

function generateResponseFromModal() {
    if (currentEmailId) {
        generateResponse(currentEmailId);
        bootstrap.Modal.getInstance(document.getElementById('emailModal')).hide();
    }
}

function copyResponse() {
    const responseText = document.getElementById('responseContent').textContent;
    navigator.clipboard.writeText(responseText).then(() => {
        showAlert('success', 'Response copied to clipboard!');
    });
}

// Custom Insights Functions
function showCustomInsights() {
    const section = document.getElementById('customInsightsSection');
    if (section) {
        section.style.display = 'block';
        section.scrollIntoView({ behavior: 'smooth' });
    }
}

function generateCustomInsights() {
    const criteria = document.getElementById('customCriteria').value.trim();
    const emailCount = document.getElementById('emailCount').value;
    const resultDiv = document.getElementById('customInsightsResult');
    const generateBtn = document.getElementById('generateInsightsBtn');
    
    if (!criteria) {
        showAlert('error', 'Please enter analysis criteria');
        return;
    }
    
    // Show loading state
    generateBtn.disabled = true;
    generateBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Generating...';
    
    resultDiv.innerHTML = `
        <div class="text-center py-4">
            <div class="spinner-border text-warning mb-3" role="status">
                <span class="visually-hidden">Loading...</span>
            </div>
            <h5>Generating Custom Insights</h5>
            <p class="text-muted">Analyzing emails based on: "${criteria}"</p>
        </div>
    `;
    
    // Call the custom insights API
    fetch('/api/pro/custom-insights', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            criteria: criteria,
            email_count: parseInt(emailCount),
            type: 'general'
        }),
        credentials: 'include'
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            resultDiv.innerHTML = `
                <div class="mb-3">
                    <h5><i class="fas fa-lightbulb me-2"></i>Custom Insights Generated</h5>
                    <p class="text-muted">Analysis based on: "${criteria}"</p>
                    <div class="row">
                        <div class="col-6">
                            <small class="text-muted">
                                <i class="fas fa-envelope me-1"></i>
                                ${data.emails_analyzed} emails analyzed
                            </small>
                        </div>
                        <div class="col-6">
                            <small class="text-muted">
                                <i class="fas fa-robot me-1"></i>
                                ${data.feature || 'Pro Custom Insights'}
                            </small>
                        </div>
                    </div>
                </div>
                <div class="border-top pt-3">
                    <h6>Custom Analysis:</h6>
                    <div class="analysis-content bg-light p-3 rounded">
                        ${formatEmailContent(data.custom_insights)}
                    </div>
                </div>
                <div class="mt-3">
                    <button class="btn btn-sm btn-outline-primary" onclick="copyCustomInsights()">
                        <i class="fas fa-copy me-1"></i>
                        Copy Insights
                    </button>
                    <button class="btn btn-sm btn-outline-success" onclick="exportCustomInsights()">
                        <i class="fas fa-download me-1"></i>
                        Export
                    </button>
                </div>
            `;
        } else {
            resultDiv.innerHTML = `
                <div class="alert alert-danger">
                    <i class="fas fa-exclamation-triangle me-2"></i>
                    <strong>Analysis Failed:</strong> ${data.error || 'Unknown error'}
                </div>
            `;
        }
    })
    .catch(error => {
        console.error('Error generating custom insights:', error);
        resultDiv.innerHTML = `
            <div class="alert alert-danger">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Error:</strong> Failed to generate custom insights. Please try again.
            </div>
        `;
    })
    .finally(() => {
        // Reset button state
        generateBtn.disabled = false;
        generateBtn.innerHTML = '<i class="fas fa-magic me-2"></i>Generate Custom Insights';
    });
}

function copyCustomInsights() {
    const insightsText = document.querySelector('#customInsightsResult .analysis-content').textContent;
    navigator.clipboard.writeText(insightsText).then(() => {
        showAlert('success', 'Custom insights copied to clipboard!');
    });
}

function exportCustomInsights() {
    const criteria = document.getElementById('customCriteria').value;
    const insightsText = document.querySelector('#customInsightsResult .analysis-content').textContent;
    const timestamp = new Date().toISOString().split('T')[0];
    
    const content = `Custom Insights Report
Generated: ${new Date().toLocaleString()}
Criteria: ${criteria}

${insightsText}`;
    
    const blob = new Blob([content], { type: 'text/plain' });
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `custom-insights-${timestamp}.txt`;
    a.click();
    window.URL.revokeObjectURL(url);
    
    showAlert('success', 'Custom insights exported!');
}

// Auto-refresh every 5 minutes
setInterval(() => {
    // Check if user is active
    if (!document.hidden) {
        // Refresh data silently
        fetch('/api/summary', {
            credentials: 'include'
        })
        .then(response => response.json())
        .then(data => {
            // Update summary if needed
            console.log('Data refreshed');
        })
        .catch(error => console.log('Refresh failed:', error));
    }
}, 300000); // 5 minutes
</script>
{% endblock %} 